<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ElraJava Status</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=VT323&display=swap" rel="stylesheet">
    
    <!-- React & Babel for Single File Execution -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Configuration -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              minecraft: ['"VT323"', 'monospace'],
            },
            colors: {
              mc: {
                bg: '#121212',
                card: '#1e1e1e',
                btn: '#303030',
                btnHover: '#404040',
                green: '#55ff55',
                red: '#ff5555',
                gold: '#ffaa00',
                gray: '#aaaaaa',
                dark: '#000000',
              }
            }
          }
        }
      }
    </script>
    
    <style>
      body {
        background-color: #121212;
        color: #e0e0e0;
      }
      /* Minecraft text shadow simulation */
      .mc-shadow {
        text-shadow: 2px 2px 0px #000000;
      }
      .mc-shadow-sm {
        text-shadow: 1px 1px 0px #3f3f3f;
      }
      /* Ensure images don't blur */
      .pixelated {
        image-rendering: pixelated;
        image-rendering: -moz-crisp-edges;
        image-rendering: crisp-edges;
      }
      /* Custom Scrollbar for player list */
      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #100010; 
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #555; 
        border: 2px solid #100010;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #777; 
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react,typescript">
      /**
       * ------------------------------------------------------------------
       * TYPES
       * ------------------------------------------------------------------
       */
      interface McSrvStatusResponse {
        online: boolean;
        ip: string;
        port: number;
        hostname?: string;
        latency?: number;
        source?: 'mcsrvstat' | 'minetools';
        version?: {
          name_raw: string;
          name_clean: string;
          name_html: string;
          protocol: number;
        };
        players?: {
          online: number;
          max: number;
          list?: Array<{
            name: string;
            uuid: string;
          }>;
        };
        motd?: {
          raw: string[];
          clean: string[];
          html: string[];
        };
        icon?: string;
        protocol?: {
          version: number;
          name: string;
        };
        error?: string;
      }

      /**
       * ------------------------------------------------------------------
       * SERVICE: Minecraft API Logic
       * ------------------------------------------------------------------
       */
      const parseAddress = (address: string) => {
        const parts = address.split(':');
        if (parts.length > 1) {
          return { host: parts[0], port: parseInt(parts[1], 10) };
        }
        return { host: address, port: null };
      };

      const fetchMcsrvStat = async (address: string): Promise<McSrvStatusResponse | null> => {
        try {
          const response = await fetch(`https://api.mcsrvstat.us/3/${encodeURIComponent(address)}?_=${Date.now()}`);
          if (!response.ok) return null;
          const data = await response.json();
          return { ...data, source: 'mcsrvstat' };
        } catch (e) {
          console.warn("Mcsrvstat failed:", e);
          return null;
        }
      };

      const fetchMinetools = async (address: string): Promise<McSrvStatusResponse | null> => {
        try {
          const { host, port } = parseAddress(address);
          const url = port 
            ? `https://api.minetools.eu/ping/${host}/${port}`
            : `https://api.minetools.eu/ping/${host}`;

          const response = await fetch(`${url}?_=${Date.now()}`);
          if (!response.ok) return null;
          const data = await response.json();

          if (data.error) return null;

          let descriptionRaw = "";
          if (typeof data.description === 'string') {
            descriptionRaw = data.description;
          } else if (typeof data.description === 'object') {
             descriptionRaw = data.description.text || JSON.stringify(data.description);
          }

          return {
            online: true,
            ip: host,
            port: port || 25565,
            hostname: host,
            latency: Math.round(data.latency),
            source: 'minetools',
            version: {
              name_raw: data.version?.name || 'Unknown',
              name_clean: data.version?.name || 'Unknown',
              name_html: data.version?.name || 'Unknown',
              protocol: data.version?.protocol || 0
            },
            players: {
              online: data.players?.online || 0,
              max: data.players?.max || 0,
              list: data.players?.sample || []
            },
            motd: {
              raw: [descriptionRaw],
              clean: [descriptionRaw],
              html: []
            },
            icon: data.favicon
          };
        } catch (e) {
          console.warn("Minetools failed:", e);
          return null;
        }
      };

      const fetchServerStatus = async (address: string): Promise<McSrvStatusResponse> => {
        if (!address.trim()) {
          throw new Error('Bitte gib eine Server-Adresse ein.');
        }

        // 1. Primary API
        let data = await fetchMcsrvStat(address);

        // 2. Fallback API
        if (!data || !data.online) {
          console.log("Primary API offline/failed, trying fallback...");
          const fallbackData = await fetchMinetools(address);
          if (fallbackData && fallbackData.online) {
            return fallbackData;
          }
          if (data) return data; 
        }

        if (data && data.online && data.source === 'mcsrvstat') {
          fetchMinetools(address).then(() => {}).catch(() => {});
        }

        if (!data) {
          throw new Error('Verbindung zur Status-API fehlgeschlagen.');
        }

        return data;
      };

      /**
       * ------------------------------------------------------------------
       * COMPONENT: MotdDisplay
       * ------------------------------------------------------------------
       */
      const MC_COLORS: Record<string, string> = {
        '0': '#000000', '1': '#0000AA', '2': '#00AA00', '3': '#00AAAA',
        '4': '#AA0000', '5': '#AA00AA', '6': '#FFAA00', '7': '#AAAAAA',
        '8': '#555555', '9': '#5555FF', 'a': '#55FF55', 'b': '#55FFFF',
        'c': '#FF5555', 'd': '#FF55FF', 'e': '#FFFF55', 'f': '#FFFFFF',
      };

      const parseMinecraftText = (text: string) => {
        if (!text) return null;
        
        const parts = text.split(/(§[0-9a-fk-or])/g);
        const elements: React.ReactNode[] = [];
        
        let style: React.CSSProperties = { color: '#AAAAAA' };
        let obfuscated = false;

        for (let i = 0; i < parts.length; i++) {
          const part = parts[i];
          if (part.startsWith('§')) {
            const code = part.charAt(1).toLowerCase();
            
            if (MC_COLORS[code]) {
              style = { color: MC_COLORS[code] };
              obfuscated = false;
            }
            else if (code === 'l') style.fontWeight = 'bold';
            else if (code === 'm') style.textDecoration = (style.textDecoration || '') + ' line-through';
            else if (code === 'n') style.textDecoration = (style.textDecoration || '') + ' underline';
            else if (code === 'o') style.fontStyle = 'italic';
            else if (code === 'r') {
              style = { color: '#AAAAAA' };
              obfuscated = false;
            }
            else if (code === 'k') obfuscated = true;
          } else {
            if (part.length > 0) {
              const lines = part.split('\n');
              lines.forEach((line, lineIdx) => {
                 if (lineIdx > 0) elements.push(<br key={`br-${i}-${lineIdx}`} />);
                 elements.push(
                   <span key={`${i}-${lineIdx}`} style={style} className={obfuscated ? 'animate-pulse bg-gray-500 text-transparent select-none' : ''}>
                     {line}
                   </span>
                 );
              });
            }
          }
        }
        return elements;
      };

      const MotdDisplay = ({ htmlMotd, cleanMotd, rawMotd }) => {
        const rawString = rawMotd?.[0] || "";
        const shouldUseRawParser = !htmlMotd || htmlMotd.length === 0 || (rawString && rawString.includes('§'));

        if (shouldUseRawParser && rawString) {
          return (
            <div className="font-minecraft text-[22px] leading-6 whitespace-pre-wrap break-words mc-shadow-sm">
              {parseMinecraftText(rawString)}
            </div>
          );
        }

        if (htmlMotd && htmlMotd.length > 0) {
          return (
            <div className="font-minecraft text-[22px] leading-6 text-gray-300">
              {htmlMotd.map((line, index) => (
                <div 
                  key={index} 
                  dangerouslySetInnerHTML={{ __html: line }} 
                  className="whitespace-pre overflow-hidden text-ellipsis h-[24px]"
                />
              ))}
            </div>
          );
        }

        if (cleanMotd && cleanMotd.length > 0) {
             return (
               <div className="font-minecraft text-gray-400 whitespace-pre text-2xl leading-tight">
                  {cleanMotd.map((line, i) => <div key={i}>{line}</div>)}
               </div>
             )
        }

        return <div className="text-gray-600 font-minecraft italic text-xl">A Minecraft Server</div>;
      };

      /**
       * ------------------------------------------------------------------
       * COMPONENT: ServerStatus
       * ------------------------------------------------------------------
       */
      const ConnectionBars = ({ latency }) => {
        if (latency === undefined) {
          return (
            <div className="flex items-end gap-[2px] h-[14px]" title="Ping: Unknown">
               {[1,2,3,4,5].map(i => <div key={i} className="w-[3px] bg-gray-600 h-full opacity-50"></div>)}
            </div>
          );
        }

        let bars = 5;
        let color = 'bg-mc-green';
        
        if (latency < 0) { bars = 0; color = 'bg-red-500'; }
        else if (latency < 75) { bars = 5; color = 'bg-mc-green'; }
        else if (latency < 150) { bars = 4; color = 'bg-mc-green'; }
        else if (latency < 300) { bars = 3; color = 'bg-yellow-500'; }
        else if (latency < 600) { bars = 2; color = 'bg-orange-500'; }
        else { bars = 1; color = 'bg-red-500'; }

        return (
          <div className="flex items-end gap-[2px] h-[14px]">
             {[1, 2, 3, 4, 5].map((i) => {
                const isActive = i <= bars;
                const height = `${i * 20}%`;
                return (
                   <div 
                     key={i} 
                     style={{ height }}
                     className={`w-[3px] ${isActive ? color : 'bg-gray-700'}`}
                   ></div>
                );
             })}
          </div>
        );
      };

      const ServerStatus = ({ data, inputAddress }) => {
        const isOnline = data.online;
        const defaultIcon = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAACyUlEQVR4Xu2b3XGEMAyE7T0oB6UglYNSkA5KQTk4B6V4x1wMyNnD+GTv3exlBsY/2ZZkYxK/Pp/P5/qjX+vH+qNf68f6+f39/fvn5+d4enq61/r+/n58fn5+hL+9vY0/Pz//F/79/f34/v7+L/z19fX4+vr6L/zDw8P48fHxX/jT09P46enpX/jj4+P4/f39X/jLy8v4y8vL//g/Pj6+3t/f/80FwB8fH8fT09P4+fn5F/z19fX49vb2L/zt7e348fHxF/7p6en4/v7+L/zDw8P46enpX/jj4+P4/f39X/jLy8v4y8vL//h/fn6+3t/f/80F+P7+Pj4/P4+np6fxt7e38efn5//Cv7+/H9/f3/+Fv76+Hl9fX/+Ff3h4GD8+Pv4Lf3p6Gj8+Pv4Lf3x8HL+/v/8Lf3l5GX95efkf/8fHx9f7+/u/uQDf39/H5+fn8fT0NP729jb+/Pz8X/j39/fj+/v7v/DX19fj6+vrv/APDw/jx8fHf+FPT0/jp6enfeG/vLzsC395edn3Av8v0D8A+gOgPwD6A6A/APoDoD8A+gOgPwD6A6A/APoDoD8A+gOgPwD6A6A/APoDoD8A+gOgPwD6A6A/APoDoD8A+gOgPwD6A6A/APoDoD8A+gOgPwD6A6A/APoDoD8A+gOgPwD6A6A/APoDoD8A+gOgPwD6A6A/APoDoD8A+gOgPwD6A6A/APoDoD8A+gOgPwD6A6A/APoDoD8A+gOgPwD6A6A/APoDoD8A+gOgPwD6A6A/APoDoD8A+gOgPwD6A6A/APoDoD8A+gOgPwD6A6A/APoDoD8A+gOgPwD6A6A/APoDoD8A+gOgPwD6A6A/APoDoD8A+gOgPwD6A6A/APoDoD8A+gOgPwD6A6A/APoDoD8A+gOgPwD6A6A/APoDoD8A+gOgPwD6A6A/APoDoD8A+gOgP4B/clM2wF4l89oAAAAASUVORK5CYII=";

        if (!isOnline) {
          return (
             <div className="w-full max-w-4xl mx-auto font-minecraft mt-4">
              <div className="bg-[#101010] border-2 border-gray-600 p-2 flex gap-4 items-center relative hover:border-gray-500 transition-colors">
                  <div className="w-[64px] h-[64px] bg-gray-900 shrink-0 flex items-center justify-center border border-gray-700 pixelated">
                     <span className="text-red-700 text-4xl">X</span>
                  </div>
                  <div className="flex-1 flex flex-col justify-center gap-1">
                     <div className="text-white text-xl mc-shadow">{inputAddress}</div>
                     <div className="text-red-500 text-xl mc-shadow">Can't connect to server</div>
                  </div>
                  <div className="flex flex-col items-end self-start h-[64px] justify-between py-1">
                     <ConnectionBars latency={-1} />
                  </div>
              </div>
            </div>
          );
        }

        const versionStr = data.version?.name_clean || "Unknown";

        return (
          <div className="w-full max-w-4xl mx-auto mt-4">
            <div className="bg-black/40 p-[2px]">
              <div className="bg-[#050505] hover:bg-[#101010] border border-gray-500/50 p-[6px] flex gap-3 h-[88px] group transition-all relative">
                
                {/* Icon */}
                <div className="shrink-0 relative">
                   <img 
                     src={data.icon || defaultIcon} 
                     alt="Server Icon" 
                     className="w-[64px] h-[64px] pixelated" 
                   />
                </div>
                
                {/* Main Info */}
                <div className="flex-1 flex flex-col pt-1 overflow-hidden relative">
                   <div className="text-white font-minecraft text-[22px] leading-none tracking-wide truncate mb-[2px] mc-shadow">
                      {data.hostname || inputAddress}
                   </div>
                   
                   <div className="overflow-hidden h-[50px] w-full">
                      <MotdDisplay 
                        htmlMotd={data.motd?.html} 
                        cleanMotd={data.motd?.clean} 
                        rawMotd={data.motd?.raw}
                      />
                   </div>
                </div>
                
                {/* Status Info */}
                <div className="flex flex-col items-end pt-1 shrink-0 ml-4 w-fit min-w-[120px]">
                   <div className="flex items-center justify-end gap-2 mb-1">
                      {data.latency !== undefined && (
                         <span className="font-minecraft text-mc-green text-lg mc-shadow leading-none">
                            {data.latency} ms
                         </span>
                      )}
                      <ConnectionBars latency={data.latency} />
                   </div>
                   
                   <div className="relative group/tooltip cursor-help mb-1">
                      <div className="font-minecraft text-gray-300 text-[20px] leading-none mc-shadow hover:text-white transition-colors">
                         {data.players?.online}
                         <span className="text-gray-500 mx-[1px]">/</span>
                         {data.players?.max}
                      </div>
                      
                      {data.players?.list && data.players.list.length > 0 && (
                        <div className="absolute right-0 top-full mt-1 z-50 hidden group-hover/tooltip:block w-max max-w-[250px]">
                           <div className="bg-[#100010] border-2 border-[#500095] rounded-none p-2 shadow-[4px_4px_0_0_rgba(0,0,0,0.5)] text-white font-minecraft text-lg">
                              <div className="text-[#55ff55] mb-2 text-center underline decoration-dashed">
                                 Connected Players
                              </div>
                              <div className="flex flex-col gap-1 max-h-[300px] overflow-y-auto custom-scrollbar pr-1">
                                 {data.players.list.map((p, idx) => (
                                   <div key={idx} className="flex items-center gap-2">
                                     <img src={`https://api.mineatar.io/head/${p.uuid}`} className="w-4 h-4 pixelated" alt="" />
                                     <span className="text-gray-200">{p.name}</span>
                                   </div>
                                 ))}
                              </div>
                              {data.players.online > data.players.list.length && (
                                 <div className="text-gray-500 text-center mt-2 text-sm">
                                    + {data.players.online - data.players.list.length} others
                                 </div>
                              )}
                           </div>
                        </div>
                      )}
                   </div>

                   <div className="font-minecraft text-[#808080] text-[18px] leading-none mc-shadow mt-auto">
                      {versionStr}
                   </div>
                </div>
              </div>
            </div>
          </div>
        );
      };

      /**
       * ------------------------------------------------------------------
       * APP
       * ------------------------------------------------------------------
       */
      const SERVER_ADDRESS = 'elrajava.de';

      const App = () => {
        const [serverData, setServerData] = React.useState(null);
        const [loading, setLoading] = React.useState(false);
        const [error, setError] = React.useState(null);
        const [lastUpdated, setLastUpdated] = React.useState(null);

        const loadStatus = React.useCallback(async () => {
          setLoading(true);
          setError(null);
          
          try {
            const data = await fetchServerStatus(SERVER_ADDRESS);
            setServerData(data);
            setLastUpdated(new Date());
          } catch (err) {
            setError(err.message || 'Server konnte nicht erreicht werden.');
            setServerData(null);
          } finally {
            setLoading(false);
          }
        }, []);

        React.useEffect(() => {
          loadStatus();
        }, [loadStatus]);

        return (
          <div className="min-h-screen bg-[#121212] bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')] text-gray-200 font-sans selection:bg-green-500/30 flex flex-col">
            <div className="max-w-4xl mx-auto px-4 py-12 w-full flex-grow">
              
              <div className="text-center mb-10">
                <h1 className="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-600 mb-2 tracking-tight">
                  ElraJava Status
                </h1>
                <p className="text-gray-400 font-minecraft text-xl">
                  {SERVER_ADDRESS}
                </p>
              </div>

              <div className="min-h-[150px] flex flex-col items-center justify-center">
                {loading && !serverData && (
                  <div className="flex flex-col items-center gap-4 text-gray-500 font-minecraft text-2xl animate-pulse">
                     <div className="w-16 h-16 border-4 border-gray-600 border-t-green-500 rounded-full animate-spin"></div>
                     Lade Serverdaten...
                  </div>
                )}

                {error && (
                  <div className="bg-red-900/20 border-l-4 border-red-500 text-red-200 p-6 rounded w-full max-w-2xl text-center">
                    <p className="font-bold text-lg mb-1">Verbindung fehlgeschlagen</p>
                    <p className="opacity-80">{error}</p>
                    <button 
                      onClick={loadStatus}
                      className="mt-4 px-4 py-2 bg-red-800 hover:bg-red-700 rounded text-white font-bold transition-colors"
                    >
                      Erneut versuchen
                    </button>
                  </div>
                )}

                {serverData && (
                  <div className="w-full animate-fade-in">
                    <ServerStatus data={serverData} inputAddress={SERVER_ADDRESS} />
                    
                    <div className="mt-8 text-center">
                       <button
                        onClick={loadStatus}
                        disabled={loading}
                        className="group px-6 py-2 bg-[#202020] hover:bg-[#303030] border border-gray-700 rounded text-gray-400 hover:text-white transition-all font-minecraft text-lg flex items-center gap-2 mx-auto disabled:opacity-50"
                       >
                         <svg 
                          className={`w-5 h-5 ${loading ? 'animate-spin' : 'group-hover:rotate-180 transition-transform duration-500'}`} 
                          fill="none" viewBox="0 0 24 24" stroke="currentColor"
                         >
                           <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                         </svg>
                         {loading ? 'Aktualisiere...' : 'Status aktualisieren'}
                       </button>
                       {lastUpdated && (
                         <p className="text-xs text-gray-600 mt-2 font-mono">
                           Zuletzt geprüft: {lastUpdated.toLocaleTimeString()}
                         </p>
                       )}
                    </div>
                  </div>
                )}
              </div>

            </div>
            
            <footer className="border-t border-gray-800 py-6 text-center text-gray-600 text-sm bg-black/20">
              <p>Unofficial Status Page for {SERVER_ADDRESS}</p>
            </footer>
          </div>
        );
      };

      /**
       * ------------------------------------------------------------------
       * MOUNT
       * ------------------------------------------------------------------
       */
      const rootElement = document.getElementById('root');
      const root = ReactDOM.createRoot(rootElement);
      root.render(<App />);

    </script>
  </body>
</html>
